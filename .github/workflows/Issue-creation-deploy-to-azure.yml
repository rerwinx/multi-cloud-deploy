name: Issue Created - Deploy to Azure

# Runs when an issue is created.
on:
  issues:
    types: [opened] 
    
# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  
  # This workflow contains a single job called "build"
  deploy-to-azure:
    
    # Check if the Issue title is the one we want from our Issue Template
    if: startsWith(github.event.issue.title, 'Deploy to Azure') 
    
    # TODO: Add an approval process
      
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      - name: Starting deployment
        uses: actions/github-script@0.5.0
        env:
          title: ${{ github.event.issue.title }}
          body: ${{ github.event.issue.body }}
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          #github-token: ${{secrets.GPR_PAT}}
          script: |
            const { title, body } = process.env;
            let gprUrl='docker.pkg.github.com/'+context.repo.owner.toLowerCase()+'/'+context.repo.repo.toLowerCase()+'/aspnetapp:latest'
            github.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ðŸ‘‹ @' + context.actor + ', kicking off deployment on Azure of (docker image ' + gprUrl + ' ) now ...'
            })
              
      - name: 'Checkout Github Action' 
        uses: actions/checkout@master
    
      - name: 'Login via Azure CLI'
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
    
      - uses: azure/docker-login@v1
        with:
          login-server: docker.pkg.github.com
          username: ${{ github.actor }}
          password: ${{secrets.GITHUB_TOKEN}}
    
      
      - uses: azure/webapps-container-deploy@v1
        with:
          app-name: 'rerwinx-aspnetapp'
          images: 'docker.pkg.github.com/rerwinx/multi-cloud-deploy/aspnetapp:${{ github.sha }}'
    
      - name: Azure logout
        run: |
          az logout
      
      - name: Update issue success
        if: (success())
        env:
          issue_number: '${{ github.event.issue.number }}'
        uses: actions/github-script@0.5.0
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            const { issue_number} = process.env;
            github.issues.createComment({
              issue_number: issue_number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'Deployed successfully to Azure:' + 'https://rerwinx-aspnetapp.azurewebsites.net/'
            })
            github.issues.addLabels({
              issue_number: issue_number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['deployed']
            })
        
      - name: Update issue failure
        if: (failure())
        env:
          issue_number: '${{github.event.issue.number}}'
        uses: actions/github-script@0.5.0
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            const { issue_number, cloud, gprUrl, customer } = process.env;
            github.issues.createComment({
              issue_number: issue_number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'Deployment to Azure failed for ' +  owner + ' :cry:'
            })
